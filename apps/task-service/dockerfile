# ============================
# 1️⃣ Build stage
# ============================
FROM node:22.4-alpine AS builder

ARG DATABASE_USER
ARG DATABASE_NAME_TASK
ARG DATABASE_URL_TASK
ARG DATABASE_PASSWORD

# Set working directory
WORKDIR /usr/src/app

# Install OpenSSL (required for Prisma on Alpine)
RUN apk add --no-cache openssl

# Copy package files
COPY package*.json ./ 

# Copy shared libraries and Prisma schema
COPY libs ./libs
COPY apps/task-service/src/infrastructure/prisma ./prisma

# Install dependencies (including dev dependencies)
RUN npm install

# Copy all remaining source code and Nest workspace configs
COPY . . 
COPY tsconfig.json nest-cli.json ./ 

# Set environment variables for database configuration
ENV DATABASE_URL_TASK=${DATABASE_URL_TASK}
ENV DATABASE_USER=${DATABASE_USER}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV DATABASE_NAME_TASK=${DATABASE_NAME_TASK}

# Generate Prisma client (ensure the correct binary is downloaded for the target platform)
RUN npx prisma generate --schema=apps/task-service/src/infrastructure/prisma/schema.prisma

# Build the NestJS app
RUN npx nest build task-service

# ============================
# 2️⃣ Production stage
# ============================
FROM node:22.4-alpine AS production

# Set working directory
WORKDIR /usr/src/app

# Install OpenSSL in the production image (if needed)
RUN apk add --no-cache openssl

# Copy package files from builder
COPY --from=builder /usr/src/app/package*.json ./ 

# Install dependencies
RUN npm install 

# Copy built files and necessary runtime assets from the builder
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/libs ./libs

# Copy Prisma schema and generated Prisma client (including engines and binaries)
COPY --from=builder /usr/src/app/apps/task-service/src/infrastructure/generated/task-service ./apps/task-service/src/infrastructure/generated/task-service
COPY --from=builder /usr/src/app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /usr/src/app/node_modules/@prisma ./node_modules/@prisma


# Set environment variables for production
ENV NODE_ENV=production
ENV PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1

# Expose the service port
EXPOSE ${Port}

# Start the application
CMD ["node", "dist/apps/task-service/main"]
