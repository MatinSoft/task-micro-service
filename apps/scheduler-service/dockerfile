# ============================
# 1️⃣ Build stage
# ============================
FROM node:22.4-alpine AS builder

# Set working directory
WORKDIR /usr/src/app

# Copy package files
COPY package*.json ./

# Copy shared libraries and Prisma schema
COPY libs ./libs
COPY apps/scheduler-service/src/infrastructure/prisma ./prisma

# Install dependencies (including dev)
RUN npm install

# Copy all remaining source code and Nest workspace configs
COPY . .
COPY tsconfig.json nest-cli.json ./

# Generate Prisma client
RUN npx prisma generate

# Build the specific NestJS app
# (If your app name is "scheduler-service" in nest-cli.json)
RUN npx nest build scheduler-service

# ============================
# 2️⃣ Production stage
# ============================
FROM node:22.4-alpine AS production

# Set working directory
WORKDIR /usr/src/app

# Copy package files from builder
COPY --from=builder /usr/src/app/package*.json ./

# Install only production dependencies
RUN npm install --include=dev

# Copy built files and necessary runtime assets
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/prisma ./prisma
COPY --from=builder /usr/src/app/libs ./libs
COPY --from=builder /usr/src/app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /usr/src/app/node_modules/@prisma ./node_modules/@prisma

# Copy environment files (adjust paths as needed)
COPY apps/scheduler-service/.env .env

# Set environment variables
ENV NODE_ENV=production
# ENV PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1

# Expose the service port
EXPOSE ${Port}

# Start the application
CMD ["node", "dist/apps/scheduler-service/main"]
